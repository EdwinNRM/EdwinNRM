name: Update Guestbook

on:
  issue_comment:
    types: [created, edited]

permissions:
  contents: write
  issues: read

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Update README Guestbook
        uses: actions/github-script@v7
        with:
          script: |
            const query = `query($owner:String!, $name:String!, $issue_number:Int!) {
              repository(owner:$owner, name:$name){
                issue(number:$issue_number) {
                  comments(first:10,orderBy:{direction:DESC, field:UPDATED_AT}) {
                    nodes {
                      author {
                        avatarUrl(size: 48)
                        login
                        url
                      }
                      url
                      bodyText
                      updatedAt
                    }
                  }
                }
              }
            }`;

            const variables = {
              owner: context.repo.owner,
              name: context.repo.repo,
              issue_number: context.issue.number
            };

            const result = await github.graphql(query, variables);

            const renderComments = (comments) => {
              return comments.reduce((prev, curr) => {
                let sanitizedText = curr.bodyText
                  .replace(/</g, '&lt;')
                  .replace(/>/g, '&gt;')
                  .replace(/(\r\n|\r|\n)/g, "<br />")
                  .replace(/\|/g, '&#124;')
                  .replace(/\[/g, '&#91;');

                return `${prev}|[<img src="${curr.author.avatarUrl}" width="48"/><br/>${curr.author.login}](${curr.author.url})|${new Date(curr.updatedAt).toLocaleString()}<br/>[Comment ðŸ”—](${curr.url})|${sanitizedText}|\n`;
              }, "| Name | Date | Message |\n|---|---|---|\n");
            };

            const fs = require('fs');
            const readme = fs.readFileSync('README.md', 'utf8');

            const updated = readme.replace(
              /(?<=<!-- Guestbook -->.*\n)[\S\s]*?(?=<!-- \/Guestbook -->|$(?![\n]))/gm,
              renderComments(result.repository.issue.comments.nodes)
            );

            fs.writeFileSync('README.md', updated, 'utf8');